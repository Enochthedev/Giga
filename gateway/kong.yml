# Kong Gateway Configuration for Giga Platform
_format_version: "3.0"
_transform: true

services:
  # Supabase Edge Functions
  - name: supabase-functions
    url: https://YOUR_PROJECT.supabase.co/functions/v1
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
            - X-Client-Info
            - apikey
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600

  # External Microservices
  - name: ecommerce-service
    url: http://localhost:3001
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
      - name: cors

  - name: payment-service
    url: http://localhost:3002
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
      - name: cors

  - name: hotel-service
    url: http://localhost:3003
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
      - name: cors

  - name: taxi-service
    url: http://localhost:3004
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
      - name: cors

  - name: notification-service
    url: http://localhost:3005
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
      - name: cors

  - name: upload-service
    url: http://localhost:3006
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
      - name: cors

routes:
  # Auth routes (Supabase Edge Functions)
  - name: auth-middleware
    service: supabase-functions
    paths:
      - /api/v1/auth/verify
    strip_path: true
    methods:
      - POST

  - name: stripe-sessions
    service: supabase-functions
    paths:
      - /api/v1/payments/sessions
    strip_path: true
    methods:
      - POST

  - name: upload-urls
    service: supabase-functions
    paths:
      - /api/v1/uploads/urls
    strip_path: true
    methods:
      - POST

  - name: notifications-edge
    service: supabase-functions
    paths:
      - /api/v1/notifications/send
      - /api/v1/notifications/bulk
      - /api/v1/notifications/mark-read
      - /api/v1/notifications/list
    strip_path: true
    methods:
      - GET
      - POST
      - PUT

  - name: webhooks
    service: supabase-functions
    paths:
      - /api/v1/webhooks/stripe
      - /api/v1/webhooks/upload
    strip_path: true
    methods:
      - POST

  # Ecommerce routes
  - name: ecommerce-products
    service: ecommerce-service
    paths:
      - /api/v1/ecommerce/products
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  - name: ecommerce-orders
    service: ecommerce-service
    paths:
      - /api/v1/ecommerce/orders
    strip_path: false
    methods:
      - GET
      - POST
      - PUT

  - name: ecommerce-cart
    service: ecommerce-service
    paths:
      - /api/v1/ecommerce/cart
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  - name: ecommerce-checkout
    service: ecommerce-service
    paths:
      - /api/v1/ecommerce/checkout
    strip_path: false
    methods:
      - POST

  # Payment routes (external processing)
  - name: payment-processing
    service: payment-service
    paths:
      - /api/v1/payments/process
      - /api/v1/payments/refund
      - /api/v1/payments/subscriptions
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  # Hotel routes
  - name: hotel-properties
    service: hotel-service
    paths:
      - /api/v1/hotels/properties
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  - name: hotel-bookings
    service: hotel-service
    paths:
      - /api/v1/hotels/bookings
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  - name: hotel-pricing
    service: hotel-service
    paths:
      - /api/v1/hotels/pricing
    strip_path: false
    methods:
      - GET
      - POST

  # Taxi routes
  - name: taxi-rides
    service: taxi-service
    paths:
      - /api/v1/taxi/rides
    strip_path: false
    methods:
      - GET
      - POST
      - PUT

  - name: taxi-drivers
    service: taxi-service
    paths:
      - /api/v1/taxi/drivers
    strip_path: false
    methods:
      - GET
      - POST
      - PUT

  # Notification routes (heavy processing)
  - name: notification-templates
    service: notification-service
    paths:
      - /api/v1/notifications/templates
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  - name: notification-campaigns
    service: notification-service
    paths:
      - /api/v1/notifications/campaigns
    strip_path: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE

  # Upload processing routes
  - name: upload-processing
    service: upload-service
    paths:
      - /api/v1/uploads/process
      - /api/v1/uploads/status
    strip_path: false
    methods:
      - GET
      - POST

plugins:
  # Global rate limiting
  - name: rate-limiting
    config:
      minute: 1000
      hour: 10000
      policy: local

  # Global CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Client-Info
        - apikey
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600

  # Request logging
  - name: file-log
    config:
      path: /var/log/kong/access.log

  # Prometheus metrics
  - name: prometheus
    config:
      per_consumer: true
